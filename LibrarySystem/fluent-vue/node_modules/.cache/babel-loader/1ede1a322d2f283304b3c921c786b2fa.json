{"ast":null,"code":"/* eslint-disable @typescript-eslint/no-non-null-assertion */\nimport { defineComponent, h, ref, toRef, nextTick, computed, Transition } from 'vue';\nimport { createTreeMate } from 'treemate';\nimport { VBinder, VFollower, VTarget } from 'vueuc';\nimport { useIsMounted, useMergedState } from 'vooks';\nimport { NInput } from '../../input';\nimport { NInternalSelectMenu } from '../../_internal';\nimport { call, useAdjustedTo, warn } from '../../_utils';\nimport { useConfig, useFormItem, useTheme, useThemeClass } from '../../_mixins';\nimport { mentionLight } from '../styles';\nimport { getRelativePosition } from './utils';\nimport style from './styles/index.cssr';\nconst mentionProps = Object.assign(Object.assign({}, useTheme.props), {\n  to: useAdjustedTo.propTo,\n  autosize: [Boolean, Object],\n  options: {\n    type: Array,\n    default: []\n  },\n  type: {\n    type: String,\n    default: 'text'\n  },\n  separator: {\n    type: String,\n    validator: separator => {\n      if (separator.length !== 1) {\n        warn('mention', \"`separator`'s length must be 1.\");\n        return false;\n      }\n\n      return true;\n    },\n    default: ' '\n  },\n  bordered: {\n    type: Boolean,\n    default: undefined\n  },\n  disabled: Boolean,\n  value: String,\n  defaultValue: {\n    type: String,\n    default: ''\n  },\n  loading: Boolean,\n  prefix: {\n    type: [String, Array],\n    default: '@'\n  },\n  placeholder: {\n    type: String,\n    default: ''\n  },\n  placement: {\n    type: String,\n    default: 'bottom-start'\n  },\n  size: String,\n  renderLabel: Function,\n  status: String,\n  'onUpdate:value': [Array, Function],\n  onUpdateValue: [Array, Function],\n  onSearch: Function,\n  onSelect: Function,\n  onFocus: Function,\n  onBlur: Function,\n  // private\n  internalDebug: Boolean\n});\nexport default defineComponent({\n  name: 'Mention',\n  props: mentionProps,\n\n  setup(props) {\n    const {\n      namespaceRef,\n      mergedClsPrefixRef,\n      mergedBorderedRef,\n      inlineThemeDisabled\n    } = useConfig(props);\n    const themeRef = useTheme('Mention', '-mention', style, mentionLight, props, mergedClsPrefixRef);\n    const formItem = useFormItem(props);\n    const inputInstRef = ref(null);\n    const cursorRef = ref(null);\n    const followerRef = ref(null);\n    const partialPatternRef = ref('');\n    let cachedPrefix = null; // cached pattern end is for partial pattern\n    // for example @abc|def\n    // end is after `c`\n\n    let cachedPartialPatternStart = null;\n    let cachedPartialPatternEnd = null;\n    const filteredOptionsRef = computed(() => {\n      const {\n        value: pattern\n      } = partialPatternRef;\n      return props.options.filter(option => {\n        if (!pattern) return true;\n\n        if (typeof option.label === 'string') {\n          return option.label.startsWith(pattern);\n        }\n\n        return option.value.startsWith(pattern);\n      });\n    });\n    const treeMateRef = computed(() => {\n      return createTreeMate(filteredOptionsRef.value, {\n        getKey: v => {\n          return v.value;\n        }\n      });\n    });\n    const selectMenuInstRef = ref(null);\n    const showMenuRef = ref(false);\n    const uncontrolledValueRef = ref(props.defaultValue);\n    const controlledValueRef = toRef(props, 'value');\n    const mergedValueRef = useMergedState(controlledValueRef, uncontrolledValueRef);\n    const cssVarsRef = computed(() => {\n      const {\n        self: {\n          menuBoxShadow\n        }\n      } = themeRef.value;\n      return {\n        '--n-menu-box-shadow': menuBoxShadow\n      };\n    });\n    const themeClassHandle = inlineThemeDisabled ? useThemeClass('mention', undefined, cssVarsRef, props) : undefined;\n\n    function doUpdateShowMenu(show) {\n      if (props.disabled) return;\n\n      if (!show) {\n        cachedPrefix = null;\n        cachedPartialPatternStart = null;\n        cachedPartialPatternEnd = null;\n      }\n\n      showMenuRef.value = show;\n    }\n\n    function doUpdateValue(value) {\n      const {\n        onUpdateValue,\n        'onUpdate:value': _onUpdateValue\n      } = props;\n      const {\n        nTriggerFormChange,\n        nTriggerFormInput\n      } = formItem;\n\n      if (_onUpdateValue) {\n        call(_onUpdateValue, value);\n      }\n\n      if (onUpdateValue) {\n        call(onUpdateValue, value);\n      }\n\n      nTriggerFormInput();\n      nTriggerFormChange();\n      uncontrolledValueRef.value = value;\n    }\n\n    function getInputEl() {\n      return props.type === 'text' ? inputInstRef.value.inputElRef : inputInstRef.value.textareaElRef;\n    }\n\n    function deriveShowMenu() {\n      var _a;\n\n      const inputEl = getInputEl();\n\n      if (document.activeElement !== inputEl) {\n        doUpdateShowMenu(false);\n        return;\n      }\n\n      const {\n        selectionEnd\n      } = inputEl;\n\n      if (selectionEnd === null) {\n        doUpdateShowMenu(false);\n        return;\n      }\n\n      const inputValue = inputEl.value;\n      const {\n        separator\n      } = props;\n      const {\n        prefix\n      } = props;\n      const prefixArray = typeof prefix === 'string' ? [prefix] : prefix;\n\n      for (let i = selectionEnd - 1; i >= 0; --i) {\n        const char = inputValue[i];\n\n        if (char === separator || char === '\\n' || char === '\\r') {\n          doUpdateShowMenu(false);\n          return;\n        }\n\n        if (prefixArray.includes(char)) {\n          const partialPattern = inputValue.slice(i + 1, selectionEnd);\n          doUpdateShowMenu(true);\n          (_a = props.onSearch) === null || _a === void 0 ? void 0 : _a.call(props, partialPattern, char);\n          partialPatternRef.value = partialPattern;\n          cachedPrefix = char;\n          cachedPartialPatternStart = i + 1;\n          cachedPartialPatternEnd = selectionEnd;\n          return;\n        }\n      }\n\n      doUpdateShowMenu(false);\n    }\n\n    function syncCursor() {\n      const {\n        value: cursorAnchor\n      } = cursorRef;\n      if (!cursorAnchor) return;\n      const inputEl = getInputEl();\n      const cursorPos = getRelativePosition(inputEl);\n      cursorPos.left += inputEl.parentElement.offsetLeft;\n      cursorAnchor.style.left = `${cursorPos.left}px`;\n      cursorAnchor.style.top = `${cursorPos.top + cursorPos.height}px`;\n    }\n\n    function syncPosition() {\n      var _a;\n\n      if (!showMenuRef.value) return;\n      (_a = followerRef.value) === null || _a === void 0 ? void 0 : _a.syncPosition();\n    }\n\n    function handleInputUpdateValue(value) {\n      doUpdateValue(value); // Vue update is mirco task.\n      // So DOM must have been done when sync start in marco task.\n      // I can't use nextTick(), Chrome doesn't update scrollLeft of INPUT\n      // element is immediatelly updated. The behavior is wired but that's what\n      // happens.\n\n      syncAfterCursorMove();\n    }\n\n    function syncAfterCursorMove() {\n      setTimeout(() => {\n        syncCursor();\n        deriveShowMenu();\n        void nextTick().then(syncPosition);\n      }, 0);\n    }\n\n    function handleInputKeyDown(e) {\n      var _a, _b;\n\n      if (e.code === 'ArrowLeft' || e.code === 'ArrowRight') {\n        if ((_a = inputInstRef.value) === null || _a === void 0 ? void 0 : _a.isCompositing) return;\n        syncAfterCursorMove();\n      } else if (e.code === 'ArrowUp' || e.code === 'ArrowDown' || e.code === 'Enter' || e.code === 'NumpadEnter') {\n        if ((_b = inputInstRef.value) === null || _b === void 0 ? void 0 : _b.isCompositing) return;\n        const {\n          value: selectMenuInst\n        } = selectMenuInstRef;\n\n        if (showMenuRef.value) {\n          if (selectMenuInst) {\n            e.preventDefault();\n\n            if (e.code === 'ArrowUp') {\n              selectMenuInst.prev();\n            } else if (e.code === 'ArrowDown') {\n              selectMenuInst.next();\n            } else {\n              // Enter\n              const pendingOptionTmNode = selectMenuInst.getPendingTmNode();\n\n              if (pendingOptionTmNode) {\n                handleSelect(pendingOptionTmNode);\n              } else {\n                doUpdateShowMenu(false);\n              }\n            }\n          }\n        } else {\n          syncAfterCursorMove();\n        }\n      }\n    }\n\n    function handleInputFocus(e) {\n      const {\n        onFocus\n      } = props;\n      onFocus === null || onFocus === void 0 ? void 0 : onFocus(e);\n      const {\n        nTriggerFormFocus\n      } = formItem;\n      nTriggerFormFocus();\n      syncAfterCursorMove();\n    }\n\n    function focus() {\n      var _a;\n\n      (_a = inputInstRef.value) === null || _a === void 0 ? void 0 : _a.focus();\n    }\n\n    function blur() {\n      var _a;\n\n      (_a = inputInstRef.value) === null || _a === void 0 ? void 0 : _a.blur();\n    }\n\n    function handleInputBlur(e) {\n      const {\n        onBlur\n      } = props;\n      onBlur === null || onBlur === void 0 ? void 0 : onBlur(e);\n      const {\n        nTriggerFormBlur\n      } = formItem;\n      nTriggerFormBlur();\n      doUpdateShowMenu(false);\n    }\n\n    function handleSelect(tmNode) {\n      var _a;\n\n      if (cachedPrefix === null || cachedPartialPatternStart === null || cachedPartialPatternEnd === null) {\n        if (process.env.NODE_ENV !== 'production') {\n          warn('mention', 'Cache works unexpectly, this is probably a bug. Please create an issue.');\n        }\n\n        return;\n      }\n\n      const {\n        rawNode: {\n          value\n        }\n      } = tmNode;\n      const inputEl = getInputEl();\n      const inputValue = inputEl.value;\n      const {\n        separator\n      } = props;\n      const nextEndPart = inputValue.slice(cachedPartialPatternEnd);\n      const alreadySeparated = nextEndPart.startsWith(separator);\n      const nextMiddlePart = `${value}${alreadySeparated ? '' : separator}`;\n      doUpdateValue(inputValue.slice(0, cachedPartialPatternStart) + nextMiddlePart + nextEndPart);\n      (_a = props.onSelect) === null || _a === void 0 ? void 0 : _a.call(props, tmNode.rawNode, cachedPrefix);\n      const nextSelectionEnd = cachedPartialPatternStart + nextMiddlePart.length + (alreadySeparated ? 1 : 0);\n      void nextTick().then(() => {\n        // input value is updated\n        inputEl.selectionStart = nextSelectionEnd;\n        inputEl.selectionEnd = nextSelectionEnd;\n        deriveShowMenu();\n      });\n    }\n\n    function handleInputMouseDown() {\n      if (!props.disabled) {\n        syncAfterCursorMove();\n      }\n    }\n\n    return {\n      namespace: namespaceRef,\n      mergedClsPrefix: mergedClsPrefixRef,\n      mergedBordered: mergedBorderedRef,\n      mergedSize: formItem.mergedSizeRef,\n      mergedStatus: formItem.mergedStatusRef,\n      mergedTheme: themeRef,\n      treeMate: treeMateRef,\n      selectMenuInstRef,\n      inputInstRef,\n      cursorRef,\n      followerRef,\n      showMenu: showMenuRef,\n      adjustedTo: useAdjustedTo(props),\n      isMounted: useIsMounted(),\n      mergedValue: mergedValueRef,\n      handleInputFocus,\n      handleInputBlur,\n      handleInputUpdateValue,\n      handleInputKeyDown,\n      handleSelect,\n      handleInputMouseDown,\n      focus,\n      blur,\n      cssVars: inlineThemeDisabled ? undefined : cssVarsRef,\n      themeClass: themeClassHandle === null || themeClassHandle === void 0 ? void 0 : themeClassHandle.themeClass,\n      onRender: themeClassHandle === null || themeClassHandle === void 0 ? void 0 : themeClassHandle.onRender\n    };\n  },\n\n  render() {\n    const {\n      mergedTheme,\n      mergedClsPrefix,\n      $slots\n    } = this;\n    return h(\"div\", {\n      class: `${mergedClsPrefix}-mention`\n    }, h(NInput, {\n      status: this.mergedStatus,\n      themeOverrides: mergedTheme.peerOverrides.Input,\n      theme: mergedTheme.peers.Input,\n      size: this.mergedSize,\n      autosize: this.autosize,\n      type: this.type,\n      ref: \"inputInstRef\",\n      placeholder: this.placeholder,\n      onMousedown: this.handleInputMouseDown,\n      onUpdateValue: this.handleInputUpdateValue,\n      onKeydown: this.handleInputKeyDown,\n      onFocus: this.handleInputFocus,\n      onBlur: this.handleInputBlur,\n      bordered: this.mergedBordered,\n      disabled: this.disabled,\n      value: this.mergedValue\n    }), h(VBinder, null, {\n      default: () => [h(VTarget, null, {\n        default: () => {\n          const style = {\n            position: 'absolute',\n            width: 0,\n            height: 0\n          };\n\n          if (process.env.NODE_ENV !== 'production' && this.internalDebug) {\n            style.width = '1px';\n            style.height = '1px';\n            style.background = 'red';\n          }\n\n          return h(\"div\", {\n            style: style,\n            ref: \"cursorRef\"\n          });\n        }\n      }), h(VFollower, {\n        ref: \"followerRef\",\n        placement: this.placement,\n        show: this.showMenu,\n        containerClass: this.namespace,\n        to: this.adjustedTo,\n        teleportDisabled: this.adjustedTo === useAdjustedTo.tdkey\n      }, {\n        default: () => h(Transition, {\n          name: \"fade-in-scale-up-transition\",\n          appear: this.isMounted\n        }, {\n          default: () => {\n            const {\n              mergedTheme,\n              onRender\n            } = this;\n            onRender === null || onRender === void 0 ? void 0 : onRender();\n            return this.showMenu ? h(NInternalSelectMenu, {\n              clsPrefix: mergedClsPrefix,\n              theme: mergedTheme.peers.InternalSelectMenu,\n              themeOverrides: mergedTheme.peerOverrides.InternalSelectMenu,\n              autoPending: true,\n              ref: \"selectMenuInstRef\",\n              class: [`${mergedClsPrefix}-mention-menu`, this.themeClass],\n              loading: this.loading,\n              treeMate: this.treeMate,\n              virtualScroll: false,\n              style: this.cssVars,\n              onToggle: this.handleSelect,\n              renderLabel: this.renderLabel\n            }, $slots) : null;\n          }\n        })\n      })]\n    }));\n  }\n\n});","map":{"version":3,"sources":["G:/VUE_FDS/fluent-vue/node_modules/naive-ui/es/mention/src/Mention.js"],"names":["defineComponent","h","ref","toRef","nextTick","computed","Transition","createTreeMate","VBinder","VFollower","VTarget","useIsMounted","useMergedState","NInput","NInternalSelectMenu","call","useAdjustedTo","warn","useConfig","useFormItem","useTheme","useThemeClass","mentionLight","getRelativePosition","style","mentionProps","Object","assign","props","to","propTo","autosize","Boolean","options","type","Array","default","String","separator","validator","length","bordered","undefined","disabled","value","defaultValue","loading","prefix","placeholder","placement","size","renderLabel","Function","status","onUpdateValue","onSearch","onSelect","onFocus","onBlur","internalDebug","name","setup","namespaceRef","mergedClsPrefixRef","mergedBorderedRef","inlineThemeDisabled","themeRef","formItem","inputInstRef","cursorRef","followerRef","partialPatternRef","cachedPrefix","cachedPartialPatternStart","cachedPartialPatternEnd","filteredOptionsRef","pattern","filter","option","label","startsWith","treeMateRef","getKey","v","selectMenuInstRef","showMenuRef","uncontrolledValueRef","controlledValueRef","mergedValueRef","cssVarsRef","self","menuBoxShadow","themeClassHandle","doUpdateShowMenu","show","doUpdateValue","_onUpdateValue","nTriggerFormChange","nTriggerFormInput","getInputEl","inputElRef","textareaElRef","deriveShowMenu","_a","inputEl","document","activeElement","selectionEnd","inputValue","prefixArray","i","char","includes","partialPattern","slice","syncCursor","cursorAnchor","cursorPos","left","parentElement","offsetLeft","top","height","syncPosition","handleInputUpdateValue","syncAfterCursorMove","setTimeout","then","handleInputKeyDown","e","_b","code","isCompositing","selectMenuInst","preventDefault","prev","next","pendingOptionTmNode","getPendingTmNode","handleSelect","handleInputFocus","nTriggerFormFocus","focus","blur","handleInputBlur","nTriggerFormBlur","tmNode","process","env","NODE_ENV","rawNode","nextEndPart","alreadySeparated","nextMiddlePart","nextSelectionEnd","selectionStart","handleInputMouseDown","namespace","mergedClsPrefix","mergedBordered","mergedSize","mergedSizeRef","mergedStatus","mergedStatusRef","mergedTheme","treeMate","showMenu","adjustedTo","isMounted","mergedValue","cssVars","themeClass","onRender","render","$slots","class","themeOverrides","peerOverrides","Input","theme","peers","onMousedown","onKeydown","position","width","background","containerClass","teleportDisabled","tdkey","appear","clsPrefix","InternalSelectMenu","autoPending","virtualScroll","onToggle"],"mappings":"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","sourcesContent":["/* eslint-disable @typescript-eslint/no-non-null-assertion */\nimport { defineComponent, h, ref, toRef, nextTick, computed, Transition } from 'vue';\nimport { createTreeMate } from 'treemate';\nimport { VBinder, VFollower, VTarget } from 'vueuc';\nimport { useIsMounted, useMergedState } from 'vooks';\nimport { NInput } from '../../input';\nimport { NInternalSelectMenu } from '../../_internal';\nimport { call, useAdjustedTo, warn } from '../../_utils';\nimport { useConfig, useFormItem, useTheme, useThemeClass } from '../../_mixins';\nimport { mentionLight } from '../styles';\nimport { getRelativePosition } from './utils';\nimport style from './styles/index.cssr';\nconst mentionProps = Object.assign(Object.assign({}, useTheme.props), { to: useAdjustedTo.propTo, autosize: [Boolean, Object], options: {\n        type: Array,\n        default: []\n    }, type: {\n        type: String,\n        default: 'text'\n    }, separator: {\n        type: String,\n        validator: (separator) => {\n            if (separator.length !== 1) {\n                warn('mention', \"`separator`'s length must be 1.\");\n                return false;\n            }\n            return true;\n        },\n        default: ' '\n    }, bordered: {\n        type: Boolean,\n        default: undefined\n    }, disabled: Boolean, value: String, defaultValue: {\n        type: String,\n        default: ''\n    }, loading: Boolean, prefix: {\n        type: [String, Array],\n        default: '@'\n    }, placeholder: {\n        type: String,\n        default: ''\n    }, placement: {\n        type: String,\n        default: 'bottom-start'\n    }, size: String, renderLabel: Function, status: String, 'onUpdate:value': [Array, Function], onUpdateValue: [Array, Function], onSearch: Function, onSelect: Function, onFocus: Function, onBlur: Function, \n    // private\n    internalDebug: Boolean });\nexport default defineComponent({\n    name: 'Mention',\n    props: mentionProps,\n    setup(props) {\n        const { namespaceRef, mergedClsPrefixRef, mergedBorderedRef, inlineThemeDisabled } = useConfig(props);\n        const themeRef = useTheme('Mention', '-mention', style, mentionLight, props, mergedClsPrefixRef);\n        const formItem = useFormItem(props);\n        const inputInstRef = ref(null);\n        const cursorRef = ref(null);\n        const followerRef = ref(null);\n        const partialPatternRef = ref('');\n        let cachedPrefix = null;\n        // cached pattern end is for partial pattern\n        // for example @abc|def\n        // end is after `c`\n        let cachedPartialPatternStart = null;\n        let cachedPartialPatternEnd = null;\n        const filteredOptionsRef = computed(() => {\n            const { value: pattern } = partialPatternRef;\n            return props.options.filter((option) => {\n                if (!pattern)\n                    return true;\n                if (typeof option.label === 'string') {\n                    return option.label.startsWith(pattern);\n                }\n                return option.value.startsWith(pattern);\n            });\n        });\n        const treeMateRef = computed(() => {\n            return createTreeMate(filteredOptionsRef.value, {\n                getKey: (v) => {\n                    return v.value;\n                }\n            });\n        });\n        const selectMenuInstRef = ref(null);\n        const showMenuRef = ref(false);\n        const uncontrolledValueRef = ref(props.defaultValue);\n        const controlledValueRef = toRef(props, 'value');\n        const mergedValueRef = useMergedState(controlledValueRef, uncontrolledValueRef);\n        const cssVarsRef = computed(() => {\n            const { self: { menuBoxShadow } } = themeRef.value;\n            return {\n                '--n-menu-box-shadow': menuBoxShadow\n            };\n        });\n        const themeClassHandle = inlineThemeDisabled\n            ? useThemeClass('mention', undefined, cssVarsRef, props)\n            : undefined;\n        function doUpdateShowMenu(show) {\n            if (props.disabled)\n                return;\n            if (!show) {\n                cachedPrefix = null;\n                cachedPartialPatternStart = null;\n                cachedPartialPatternEnd = null;\n            }\n            showMenuRef.value = show;\n        }\n        function doUpdateValue(value) {\n            const { onUpdateValue, 'onUpdate:value': _onUpdateValue } = props;\n            const { nTriggerFormChange, nTriggerFormInput } = formItem;\n            if (_onUpdateValue) {\n                call(_onUpdateValue, value);\n            }\n            if (onUpdateValue) {\n                call(onUpdateValue, value);\n            }\n            nTriggerFormInput();\n            nTriggerFormChange();\n            uncontrolledValueRef.value = value;\n        }\n        function getInputEl() {\n            return props.type === 'text'\n                ? inputInstRef.value.inputElRef\n                : inputInstRef.value.textareaElRef;\n        }\n        function deriveShowMenu() {\n            var _a;\n            const inputEl = getInputEl();\n            if (document.activeElement !== inputEl) {\n                doUpdateShowMenu(false);\n                return;\n            }\n            const { selectionEnd } = inputEl;\n            if (selectionEnd === null) {\n                doUpdateShowMenu(false);\n                return;\n            }\n            const inputValue = inputEl.value;\n            const { separator } = props;\n            const { prefix } = props;\n            const prefixArray = typeof prefix === 'string' ? [prefix] : prefix;\n            for (let i = selectionEnd - 1; i >= 0; --i) {\n                const char = inputValue[i];\n                if (char === separator || char === '\\n' || char === '\\r') {\n                    doUpdateShowMenu(false);\n                    return;\n                }\n                if (prefixArray.includes(char)) {\n                    const partialPattern = inputValue.slice(i + 1, selectionEnd);\n                    doUpdateShowMenu(true);\n                    (_a = props.onSearch) === null || _a === void 0 ? void 0 : _a.call(props, partialPattern, char);\n                    partialPatternRef.value = partialPattern;\n                    cachedPrefix = char;\n                    cachedPartialPatternStart = i + 1;\n                    cachedPartialPatternEnd = selectionEnd;\n                    return;\n                }\n            }\n            doUpdateShowMenu(false);\n        }\n        function syncCursor() {\n            const { value: cursorAnchor } = cursorRef;\n            if (!cursorAnchor)\n                return;\n            const inputEl = getInputEl();\n            const cursorPos = getRelativePosition(inputEl);\n            cursorPos.left += inputEl.parentElement.offsetLeft;\n            cursorAnchor.style.left = `${cursorPos.left}px`;\n            cursorAnchor.style.top = `${cursorPos.top + cursorPos.height}px`;\n        }\n        function syncPosition() {\n            var _a;\n            if (!showMenuRef.value)\n                return;\n            (_a = followerRef.value) === null || _a === void 0 ? void 0 : _a.syncPosition();\n        }\n        function handleInputUpdateValue(value) {\n            doUpdateValue(value);\n            // Vue update is mirco task.\n            // So DOM must have been done when sync start in marco task.\n            // I can't use nextTick(), Chrome doesn't update scrollLeft of INPUT\n            // element is immediatelly updated. The behavior is wired but that's what\n            // happens.\n            syncAfterCursorMove();\n        }\n        function syncAfterCursorMove() {\n            setTimeout(() => {\n                syncCursor();\n                deriveShowMenu();\n                void nextTick().then(syncPosition);\n            }, 0);\n        }\n        function handleInputKeyDown(e) {\n            var _a, _b;\n            if (e.code === 'ArrowLeft' || e.code === 'ArrowRight') {\n                if ((_a = inputInstRef.value) === null || _a === void 0 ? void 0 : _a.isCompositing)\n                    return;\n                syncAfterCursorMove();\n            }\n            else if (e.code === 'ArrowUp' ||\n                e.code === 'ArrowDown' ||\n                e.code === 'Enter' ||\n                e.code === 'NumpadEnter') {\n                if ((_b = inputInstRef.value) === null || _b === void 0 ? void 0 : _b.isCompositing)\n                    return;\n                const { value: selectMenuInst } = selectMenuInstRef;\n                if (showMenuRef.value) {\n                    if (selectMenuInst) {\n                        e.preventDefault();\n                        if (e.code === 'ArrowUp') {\n                            selectMenuInst.prev();\n                        }\n                        else if (e.code === 'ArrowDown') {\n                            selectMenuInst.next();\n                        }\n                        else {\n                            // Enter\n                            const pendingOptionTmNode = selectMenuInst.getPendingTmNode();\n                            if (pendingOptionTmNode) {\n                                handleSelect(pendingOptionTmNode);\n                            }\n                            else {\n                                doUpdateShowMenu(false);\n                            }\n                        }\n                    }\n                }\n                else {\n                    syncAfterCursorMove();\n                }\n            }\n        }\n        function handleInputFocus(e) {\n            const { onFocus } = props;\n            onFocus === null || onFocus === void 0 ? void 0 : onFocus(e);\n            const { nTriggerFormFocus } = formItem;\n            nTriggerFormFocus();\n            syncAfterCursorMove();\n        }\n        function focus() {\n            var _a;\n            (_a = inputInstRef.value) === null || _a === void 0 ? void 0 : _a.focus();\n        }\n        function blur() {\n            var _a;\n            (_a = inputInstRef.value) === null || _a === void 0 ? void 0 : _a.blur();\n        }\n        function handleInputBlur(e) {\n            const { onBlur } = props;\n            onBlur === null || onBlur === void 0 ? void 0 : onBlur(e);\n            const { nTriggerFormBlur } = formItem;\n            nTriggerFormBlur();\n            doUpdateShowMenu(false);\n        }\n        function handleSelect(tmNode) {\n            var _a;\n            if (cachedPrefix === null ||\n                cachedPartialPatternStart === null ||\n                cachedPartialPatternEnd === null) {\n                if (process.env.NODE_ENV !== 'production') {\n                    warn('mention', 'Cache works unexpectly, this is probably a bug. Please create an issue.');\n                }\n                return;\n            }\n            const { rawNode: { value } } = tmNode;\n            const inputEl = getInputEl();\n            const inputValue = inputEl.value;\n            const { separator } = props;\n            const nextEndPart = inputValue.slice(cachedPartialPatternEnd);\n            const alreadySeparated = nextEndPart.startsWith(separator);\n            const nextMiddlePart = `${value}${alreadySeparated ? '' : separator}`;\n            doUpdateValue(inputValue.slice(0, cachedPartialPatternStart) +\n                nextMiddlePart +\n                nextEndPart);\n            (_a = props.onSelect) === null || _a === void 0 ? void 0 : _a.call(props, tmNode.rawNode, cachedPrefix);\n            const nextSelectionEnd = cachedPartialPatternStart +\n                nextMiddlePart.length +\n                (alreadySeparated ? 1 : 0);\n            void nextTick().then(() => {\n                // input value is updated\n                inputEl.selectionStart = nextSelectionEnd;\n                inputEl.selectionEnd = nextSelectionEnd;\n                deriveShowMenu();\n            });\n        }\n        function handleInputMouseDown() {\n            if (!props.disabled) {\n                syncAfterCursorMove();\n            }\n        }\n        return {\n            namespace: namespaceRef,\n            mergedClsPrefix: mergedClsPrefixRef,\n            mergedBordered: mergedBorderedRef,\n            mergedSize: formItem.mergedSizeRef,\n            mergedStatus: formItem.mergedStatusRef,\n            mergedTheme: themeRef,\n            treeMate: treeMateRef,\n            selectMenuInstRef,\n            inputInstRef,\n            cursorRef,\n            followerRef,\n            showMenu: showMenuRef,\n            adjustedTo: useAdjustedTo(props),\n            isMounted: useIsMounted(),\n            mergedValue: mergedValueRef,\n            handleInputFocus,\n            handleInputBlur,\n            handleInputUpdateValue,\n            handleInputKeyDown,\n            handleSelect,\n            handleInputMouseDown,\n            focus,\n            blur,\n            cssVars: inlineThemeDisabled ? undefined : cssVarsRef,\n            themeClass: themeClassHandle === null || themeClassHandle === void 0 ? void 0 : themeClassHandle.themeClass,\n            onRender: themeClassHandle === null || themeClassHandle === void 0 ? void 0 : themeClassHandle.onRender\n        };\n    },\n    render() {\n        const { mergedTheme, mergedClsPrefix, $slots } = this;\n        return (h(\"div\", { class: `${mergedClsPrefix}-mention` },\n            h(NInput, { status: this.mergedStatus, themeOverrides: mergedTheme.peerOverrides.Input, theme: mergedTheme.peers.Input, size: this.mergedSize, autosize: this.autosize, type: this.type, ref: \"inputInstRef\", placeholder: this.placeholder, onMousedown: this.handleInputMouseDown, onUpdateValue: this.handleInputUpdateValue, onKeydown: this.handleInputKeyDown, onFocus: this.handleInputFocus, onBlur: this.handleInputBlur, bordered: this.mergedBordered, disabled: this.disabled, value: this.mergedValue }),\n            h(VBinder, null, {\n                default: () => [\n                    h(VTarget, null, {\n                        default: () => {\n                            const style = {\n                                position: 'absolute',\n                                width: 0,\n                                height: 0\n                            };\n                            if (process.env.NODE_ENV !== 'production' && this.internalDebug) {\n                                style.width = '1px';\n                                style.height = '1px';\n                                style.background = 'red';\n                            }\n                            return h(\"div\", { style: style, ref: \"cursorRef\" });\n                        }\n                    }),\n                    h(VFollower, { ref: \"followerRef\", placement: this.placement, show: this.showMenu, containerClass: this.namespace, to: this.adjustedTo, teleportDisabled: this.adjustedTo === useAdjustedTo.tdkey }, {\n                        default: () => (h(Transition, { name: \"fade-in-scale-up-transition\", appear: this.isMounted }, {\n                            default: () => {\n                                const { mergedTheme, onRender } = this;\n                                onRender === null || onRender === void 0 ? void 0 : onRender();\n                                return this.showMenu ? (h(NInternalSelectMenu, { clsPrefix: mergedClsPrefix, theme: mergedTheme.peers.InternalSelectMenu, themeOverrides: mergedTheme.peerOverrides.InternalSelectMenu, autoPending: true, ref: \"selectMenuInstRef\", class: [\n                                        `${mergedClsPrefix}-mention-menu`,\n                                        this.themeClass\n                                    ], loading: this.loading, treeMate: this.treeMate, virtualScroll: false, style: this.cssVars, onToggle: this.handleSelect, renderLabel: this.renderLabel }, $slots)) : null;\n                            }\n                        }))\n                    })\n                ]\n            })));\n    }\n});\n"]},"metadata":{},"sourceType":"module"}